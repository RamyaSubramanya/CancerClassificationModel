# .github/workflows/azureml-deploy.yml
name: Train and Deploy on Azure ML

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Azure ML CLI
      run: |
        pip install azure-cli
        az extension add -n ml -y

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Submit Training Job
      id: train
      run: |
        JOB_ID=$(az ml job create \
          --file .azureml/job.yml \
          --workspace-name ${{ secrets.AZURE_WORKSPACE_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --query name -o tsv)
        echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT

    - name: Register Model
      run: |
        az ml model create \
          --name my-model \
          --type custom_model \
          --path azureml://jobs/${{ steps.train.outputs.job_id }}/outputs/model_output \
          --workspace-name ${{ secrets.AZURE_WORKSPACE_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}

    - name: Deploy Model to Endpoint
      run: |
        az ml online-endpoint create \
          --file .azureml/deploy.yml \
          --workspace-name ${{ secrets.AZURE_WORKSPACE_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} || \
        az ml online-endpoint update \
          --file .azureml/deploy.yml \
          --workspace-name ${{ secrets.AZURE_WORKSPACE_NAME }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}